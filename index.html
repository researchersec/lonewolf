<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WoW Item Search</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/dataTables.bootstrap4.min.css">
</head>
<body class="bg-dark text-white">
    <div class="container mt-5">
        <h1 class="text-center mb-4">WoW Item Search</h1>
        <div class="input-group mb-3">
            <input type="text" class="form-control" id="searchInput" placeholder="Search by Item Name" onkeyup="handleEnterKey(event)">
            <div class="input-group-append">
                <button class="btn btn-outline-secondary" onclick="searchItem()">Search</button>
            </div>
        </div>
        
        <div id="result"></div>
        <div id="debugInfo" class="mt-4 text-info"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.21/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://wow.zamimg.com/js/tooltips.js"></script>

    <script>
        let jsonData = [];
        let itemsTxt = "";
        let itemMap = new Map();
        let debugInfo = document.getElementById("debugInfo");

        debugInfo.innerHTML += "<p>Fetching 2024-02-03_02-21-51.json...</p>";
        fetch('2024-02-03_02-21-51.json')
            .then(response => response.json())
            .then(data => {
                jsonData = data;

                // Preprocess the data into a Map for faster lookups
                itemMap = new Map(jsonData.pricing_data.map(item => [item.itemId.toString(), item]));

                debugInfo.innerHTML += "<p>2024-02-03_02-21-51.json loaded successfully.</p>";
            })
            .catch(error => console.error('Error loading 2024-02-03_02-21-51.json:', error));

        debugInfo.innerHTML += "<p>Fetching items.txt...</p>";
        fetch('items.txt')
            .then(response => response.text())
            .then(txtData => {
                itemsTxt = txtData;
                debugInfo.innerHTML += "<p>items.txt loaded successfully.</p>";
            })
            .catch(error => console.error('Error loading items.txt:', error));

        function searchItem() {
            const searchInput = document.getElementById("searchInput").value.toLowerCase();

            // Check if data is loaded
            if (!itemMap || !itemsTxt) {
                debugInfo.innerHTML += "<p>Data not loaded yet. Please try again in a moment.</p>";
                return;
            }

            debugInfo.innerHTML += "<p>Searching for: " + searchInput + "</p>";

            const matchingItems = [];

            // Search in the Map for matching items
            itemMap.forEach((item, itemId) => {
                const itemName = getItemNameById(itemId);

                if (itemName.toLowerCase().includes(searchInput)) {
                    const minBuyoutGold = item.minBuyout / 10000;
                    matchingItems.push({
                        itemName: itemName,
                        minBuyoutGold: minBuyoutGold.toFixed(2)
                    });
                }
            });

            const resultDiv = document.getElementById("result");
            resultDiv.innerHTML = "";

            if (matchingItems.length > 0) {
                debugInfo.innerHTML += "<p>Matching items found: " + JSON.stringify(matchingItems) + "</p>";

                resultDiv.innerHTML += "<h2 class='mt-4 mb-3'>Search Results</h2>";
                resultDiv.innerHTML += "<table id='resultsTable' class='table table-dark table-striped'>";
                resultDiv.innerHTML += "<thead><tr><th>Item Name</th><th>Min Buyout</th></tr></thead>";
                resultDiv.innerHTML += "<tbody>";
                for (let k = 0; k < matchingItems.length; k++) {
                    resultDiv.innerHTML += `<tr><td data-wowhead='item=${matchingItems[k].itemId}'><a href='https://www.wowhead.com/item=${matchingItems[k].itemId}' target='_blank'>${matchingItems[k].itemName}</a></td><td>${matchingItems[k].minBuyoutGold} gold</td></tr>`;
                }
                resultDiv.innerHTML += "</tbody></table>";
                
                // Initialize the DataTable with default sorting
                $('#resultsTable').DataTable();
                $('[data-toggle="tooltip"]').tooltip();
            } else {
                debugInfo.innerHTML += "<p>No matching items found.</p>";
                resultDiv.innerHTML = "<p class='mt-4'>No matching items found.</p>";
            }
        }

        function getItemNameById(itemId) {
            const itemsArray = itemsTxt.split('\n').map(line => line.split(','));

            const matchingItem = itemsArray.find(item => item[0] === itemId);

            if (matchingItem && matchingItem.length >= 2) {
                return matchingItem[1];
            } else {
                return "Unknown Item";
            }
        }

        function handleEnterKey(event) {
            // Number 13 is the "Enter" key on the keyboard
            if (event.keyCode === 13) {
                // Cancel the default action (if any)
                event.preventDefault();
                // Trigger the search function
                searchItem();
            }
        }
    </script>
</body>
</html>
